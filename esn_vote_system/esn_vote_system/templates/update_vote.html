{% extends 'base.html' %}

{% block title %}ESN ULB Brussels - Update Vote{% endblock %}

{% block content %}

{% load custom_filter %}

<div class="flex justify-center px-6 lg:px-8">
  <div class="max-w-md w-full glass-card p-6 md:p-8">
    <h1 class="text-2xl font-title font-bold mb-6 text-slate-800">Update Vote</h1>

    <form action="{% url 'vote_update' vote.id %}" method="post" class="flex flex-col gap-4">
      {% csrf_token %}
      <div class="flex flex-col">
        <label for="title" class="mb-2 text-sm font-medium text-slate-700">Title</label>
        <input id="title" name="title" type="text" placeholder="Enter title"
               value="{{ vote.title }}"
               class="glass-input focus-ring px-4 py-3 rounded-2xl text-slate-800 placeholder:text-slate-400 transition-shadow"
               required>
      </div>

      <div class="flex flex-col">
        <label for="description" class="mb-2 text-sm font-medium text-slate-700">Description</label>
        <textarea id="description" name="description" placeholder="Enter description"
                  class="glass-input focus-ring px-4 py-3 rounded-2xl text-slate-800 placeholder:text-slate-400 transition-shadow"
                  required>{{ vote.description }}</textarea>
      </div>

      <div class="flex flex-col">
        <label for="max_num_choices" class="mb-2 text-sm font-medium text-slate-700">Maximum Number of Choices</label>
        <input id="max_num_choices" name="max_num_choices" type="number" min="1"
               value="{{ vote.max_num_choices }}"
               class="glass-input focus-ring px-4 py-3 rounded-2xl text-slate-800 placeholder:text-slate-400 transition-shadow">
      </div>

      <div class="flex flex-col">
        <label for="session_id" class="mb-2 text-sm font-medium text-slate-700">Session</label>
        <select id="session_id" name="session_id"
                class="glass-input focus-ring px-4 py-3 rounded-2xl text-slate-800 placeholder:text-slate-400 transition-shadow"
                required>
          {% for session in sessions %}
            <option {% if vote.session.id == session.id %} selected {% endif %} value="{{ session.id }}">{{ session.title }}</option>
          {% endfor %}
        </select>
      </div>

      <div id="options-container" class="flex flex-col gap-4">
        <label class="text-sm font-medium text-slate-700">Options</label>
        <div class="flex items-center gap-4">
          <input name="option_text" type="text" placeholder="Enter option"
                 value="{{ vote.id|get_first_vote_option_by_vote_id }}"
                 class="glass-input focus-ring px-4 py-3 rounded-2xl text-slate-800 placeholder:text-slate-400 transition-shadow flex-grow"
                 required>
        </div>
        <div class="flex items-center gap-4">
          <input name="option_text" type="text" placeholder="Enter option"
                 value="{{ vote.id|get_second_vote_option_by_vote_id }}"
                 class="glass-input focus-ring px-4 py-3 rounded-2xl text-slate-800 placeholder:text-slate-400 transition-shadow flex-grow"
                 required>
        </div>

        {% if vote.id|get_number_of_vote_options_by_vote_id > 2 %}
          {% for option in vote.id|get_third_more_vote_options_by_vote_id %}
          <div class="flex items-center gap-4">
            <input name="option_text" type="text" placeholder="Enter option"
                   value="{{ option.option_text }}"
                   class="glass-input focus-ring px-4 py-3 rounded-2xl text-slate-800 placeholder:text-slate-400 transition-shadow flex-grow"
                   required>
            <button type="button" class="glass-btn px-4 py-2 rounded-2xl text-sm"
                    style="background-image: linear-gradient(90deg, rgba(244,123,32,0.95), rgba(244,150,50,0.92));"
                    onclick="removeOption(this)">Remove</button>
          </div>
          {% endfor %}
        {% endif %}
      </div>

      <button type="button" onclick="addOption()"
              class="glass-btn px-4 py-2 rounded-2xl text-sm mx-auto" style="background-image: linear-gradient(90deg, rgba(65, 154, 186, 0.95), rgba(0,200,255,0.92));">
        + Add Option
      </button>

      <div class="flex flex-col gap-4 mt-6">
        <button type="submit"
                class="glass-btn px-4 py-3 rounded-2xl text-base mx-auto" style="background-image: linear-gradient(90deg, rgba(105, 186, 43, 0.95), rgba(66, 115, 23, 0.92));">
          Update Vote
        </button>
        <a href="{% url 'delete_vote' vote.id %}" class="glass-btn px-4 py-3 rounded-2xl text-base mx-auto"
           style="background-image: linear-gradient(90deg, rgba(244,67,54,0.95), rgba(244,80,80,0.92));">
          Delete Vote
        </a>
        <a href="{% url 'publish_vote' vote.id %}" class="glass-btn px-4 py-3 rounded-2xl text-base mx-auto"
           style="background-image: linear-gradient(90deg, rgba(233,30,99,0.95), rgba(244,67,123,0.92));">
          Publish Vote
        </a>
      </div>
    </form>

    <a href="{% url 'admin_view' %}" class="mt-8 w-full glass-btn px-4 py-3 rounded-2xl text-center"
       style="background-image: linear-gradient(90deg, rgba(244,123,32,0.95), rgba(244,150,50,0.92));">
      Back
    </a>
  </div>
</div>

<script>
  let optionCounter = {{ vote.id|get_number_of_vote_options_by_vote_id }};

  function addOption() {
    optionCounter++;
    const container = document.getElementById('options-container');
    const div = document.createElement('div');
    div.setAttribute('class', 'flex items-center gap-4');
    const input = document.createElement('input');
    input.setAttribute('class', 'glass-input focus-ring px-4 py-3 rounded-2xl text-slate-800 placeholder:text-slate-400 transition-shadow flex-grow');
    input.setAttribute('name', 'option_text');
    input.setAttribute('type', 'text');
    input.setAttribute('placeholder', 'Enter option');
    input.setAttribute('required', '');
    div.appendChild(input);

    const removeBtn = document.createElement('button');
    removeBtn.setAttribute('type', 'button');
    removeBtn.setAttribute('class', 'glass-btn px-4 py-2 rounded-2xl text-sm');
    removeBtn.setAttribute('style', 'background-image: linear-gradient(90deg, rgba(244,123,32,0.95), rgba(244,150,50,0.92));');
    removeBtn.textContent = 'Remove';
    removeBtn.onclick = function () {
      container.removeChild(div);
      optionCounter--;
    };
    div.appendChild(removeBtn);

    container.appendChild(div);
  }

  function removeOption(button) {
    const container = document.getElementById('options-container');
    container.removeChild(button.parentElement);
    optionCounter--;
  }
</script>
{% endblock %}
